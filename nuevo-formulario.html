<script>
  function setupCanvas(canvasId) {
    const canvas = document.getElementById(canvasId);
    const ctx = canvas.getContext('2d');
    let isDrawing = false;

    canvas.addEventListener('pointerdown', e => {
      isDrawing = true;
      ctx.beginPath();
      ctx.moveTo(e.offsetX, e.offsetY);
    });

    canvas.addEventListener('pointermove', e => {
      if (isDrawing) {
        ctx.lineTo(e.offsetX, e.offsetY);
        ctx.stroke();
      }
    });

    canvas.addEventListener('pointerup', () => isDrawing = false);
    canvas.addEventListener('pointerleave', () => isDrawing = false);
  }

  function limpiarFirma(id) {
    const canvas = document.getElementById(id);
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, canvas.width, canvas.height);
  }

  setupCanvas('firma1');
  setupCanvas('firma2');

  document.getElementById('cleaningForm').addEventListener('submit', async e => {
    e.preventDefault();
    const form = e.target;
    const archivos = document.getElementById('archivos').files;
    const formData = new FormData();

    formData.append('fecha', form.fecha.value);
    formData.append('aeronave', form.aeronave.value);
    formData.append('posicion', form.posicion.value);
    formData.append('tipo_limpieza', form.tipo_limpieza.value);
    formData.append('hora_inicio', form.hora_inicio.value);
    formData.append('hora_finalizacion', form.hora_finalizacion.value);
    formData.append('estado_limpieza', form.estado_limpieza.value);
    formData.append('observaciones', form.observaciones.value);
    formData.append('responsable_limpieza', form.responsable_limpieza.value);
    formData.append('responsable_recibe', form.responsable_recibe.value);
    formData.append('firma1', document.getElementById('firma1').toDataURL());
    formData.append('firma2', document.getElementById('firma2').toDataURL());

    for (let i = 0; i < archivos.length; i++) {
      formData.append('archivos[]', archivos[i]);
    }

    try {
      // 1️⃣ Enviar a Google Sheets
      await fetch('https://script.google.com/macros/s/AKfycbymQXoYCkBWF1BTgJUBb1qCCkL6RG35UQxVXz7MqK0JMFGTuk18B7RbQzUgyyg6ToeR/exec', {
        method: 'POST',
        body: formData
      })
      .then(res => res.text())
      .then(msg => console.log("Guardado en Google Sheets:", msg));

      // 2️⃣ Enviar a Drive para PDF y adjuntos
      await fetch('https://script.google.com/macros/s/AKfycbx3CH4KRvol1-1ukK1fdwd2t9hNdhAGijVgEW2JSI4v7iIg10bi8cJn47oDUnDIwIcu/exec', {
        method: 'POST',
        body: formData
      })
      .then(res => res.text())
      .then(msg => alert("Formulario enviado y PDF creado con éxito.\n" + msg));
    } catch (err) {
      alert('Error al enviar: ' + err);
    }
  });
</script>
