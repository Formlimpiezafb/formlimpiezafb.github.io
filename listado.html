<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>Listado Formularios</title>
<style>
  body { font-family: Arial, sans-serif; max-width: 950px; margin: auto; }
  table { width: 100%; border-collapse: collapse; margin-top: 20px;}
  th, td { border: 1px solid #ccc; padding: 8px; text-align: center; cursor: pointer; }
  th { background: #eee; position: relative; }
  th span.arrow { font-size: 0.8em; margin-left: 5px; }
  input { margin: 5px 10px 10px 0; padding: 5px; width: 180px; }
  a { text-decoration: none; color: blue; }
</style>
</head>
<body>
  <h2>Listado Formularios</h2>

  <label>Filtrar por Fecha: <input type="date" id="filtroFecha" /></label>
  <label>Filtrar por Matrícula: <input type="text" id="filtroMatricula" placeholder="Matrícula..." /></label>

  <h3>Pendientes</h3>
  <table id="tablaPendientes">
    <thead>
      <tr>
        <th>#</th><th>Fecha</th><th>Matrícula</th><th>Estado</th><th>Acción</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <h3>Completados</h3>
  <table id="tablaCompletados">
    <thead>
      <tr>
        <th>#</th><th>Fecha</th><th>Matrícula</th><th>Estado</th><th>Condición</th><th>PDF</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

<script>
const url = 'https://script.google.com/macros/s/AKfycbw5EncQWBm3x3Zmzhv_BJo0ui_apq1pq1-hx7C9geLm9SQIB5oO3nn4zNrX9GW2aj6B/exec';
let dataPendientes = [];
let dataCompletados = [];
let sortPend = {};
let sortComp = {};

function formatFecha(fechaStr){
  if(!fechaStr) return '';
  const fecha = new Date(fechaStr);
  if(isNaN(fecha)) return fechaStr;
  const dd = String(fecha.getDate()).padStart(2,'0');
  const mm = String(fecha.getMonth() + 1).padStart(2,'0');
  const yyyy = fecha.getFullYear();
  return `${dd}/${mm}/${yyyy}`;
}

async function cargarDatos(){
  try {
    let resp = await fetch(url + '?action=list');
    let data = await resp.json();
    dataPendientes = data.pendientes;
    dataCompletados = data.completados;
    aplicarFiltrosYRender();
  } catch(err){
    alert('Error al cargar listado: ' + err.message);
  }
}

function aplicarFiltrosYRender(){
  const filtroFecha = document.getElementById('filtroFecha').value;
  const filtroMat = document.getElementById('filtroMatricula').value.toLowerCase();

  let tbodyPend = document.querySelector('#tablaPendientes tbody');
  let tbodyComp = document.querySelector('#tablaCompletados tbody');
  tbodyPend.innerHTML = '';
  tbodyComp.innerHTML = '';

  dataPendientes.forEach((f, index) => {
    const fechaForm = formatFecha(f.Fecha);
    const mat = f.Matrícula ? f.Matrícula.toLowerCase() : '';
    const estado = f.Estado ? f.Estado.toLowerCase() : '';
    if(filtroFecha && fechaForm !== formatFecha(filtroFecha)) return;
    if(filtroMat && !mat.includes(filtroMat)) return;

    let tr = document.createElement('tr');
    tr.innerHTML = `<td>${index + 1}</td>
      <td>${fechaForm}</td>
      <td>${f.Matrícula}</td>
      <td>${f.Estado}</td>
      <td><button onclick="abrirRecepcion('${f.ID}')">Abrir Recepción</button></td>`;
    tbodyPend.appendChild(tr);
  });

  dataCompletados.forEach((f, index) => {
    const fechaForm = formatFecha(f.Fecha);
    const mat = f.Matrícula ? f.Matrícula.toLowerCase() : '';
    const estado = f.Estado ? f.Estado.toLowerCase() : '';
    if(filtroFecha && fechaForm !== formatFecha(filtroFecha)) return;
    if(filtroMat && !mat.includes(filtroMat)) return;

    let tr = document.createElement('tr');
    tr.innerHTML = `<td>${index + 1}</td>
      <td>${fechaForm}</td>
      <td>${f.Matrícula}</td>
      <td>${f.Estado}</td>
      <td>${f.Conforme || f['Condición'] || ''}</td>
      <td><a href="${f['PDF Generado URL']}" target="_blank">Ver PDF</a></td>`;
    tbodyComp.appendChild(tr);
  });
}

function abrirRecepcion(id){
  window.open('recepcion.html?id=' + encodeURIComponent(id), '_blank');
}

// Eventos de filtros
document.getElementById('filtroFecha').addEventListener('input', aplicarFiltrosYRender);
document.getElementById('filtroMatricula').addEventListener('input', aplicarFiltrosYRender);

// Ordenamiento
function ordenarTabla(dataArray, key, isPendientes=true){
  let sortObj = isPendientes ? sortPend : sortComp;
  let asc = sortObj[key] === undefined ? true : !sortObj[key];
  sortObj[key] = asc;

  dataArray.sort((a,b)=>{
    let va = a[key] || '';
    let vb = b[key] || '';
    if(key === 'Fecha'){ va = new Date(va); vb = new Date(vb); }
    if(va < vb) return asc ? -1 : 1;
    if(va > vb) return asc ? 1 : -1;
    return 0;
  });

  const ths = isPendientes ? document.querySelectorAll('#tablaPendientes th') : document.querySelectorAll('#tablaCompletados th');
  ths.forEach(th => { let span = th.querySelector('.arrow'); if(span) th.removeChild(span); });
  ths.forEach(th=>{ if(th.innerText.trim() === key){ let arrow = document.createElement('span'); arrow.className='arrow'; arrow.innerHTML=asc?'▲':'▼'; th.appendChild(arrow); } });
  aplicarFiltrosYRender();
}

document.querySelectorAll('#tablaPendientes th').forEach((th, idx)=>{ if(idx===4) return; th.addEventListener('click', ()=>ordenarTabla(dataPendientes, th.innerText.trim(), true)); });
document.querySelectorAll('#tablaCompletados th').forEach((th, idx)=>{ if(idx===5) return; th.addEventListener('click', ()=>ordenarTabla(dataCompletados, th.innerText.trim(), false)); });

window.onload = cargarDatos;
</script>
</body>
</html>
