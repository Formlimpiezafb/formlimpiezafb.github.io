<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>Listado Formularios</title>
<style>
  body { font-family: Arial, sans-serif; max-width: 1000px; margin: auto; }
  table { width: 100%; border-collapse: collapse; margin-top: 20px;}
  th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
  th { background: #eee; }
  select, input { margin: 5px; padding: 5px; }
  button { padding: 5px 10px; }
</style>
</head>
<body>
  <h2>Listado Formularios</h2>

  <div>
    <label>Filtrar por Fecha: <input type="date" id="filtroFecha" /></label>
    <label>Filtrar por Matrícula: 
      <select id="filtroMatricula">
        <option value="">Todas</option>
      </select>
    </label>
  </div>

  <h3>Pendientes</h3>
  <table id="tablaPendientes">
    <thead>
      <tr>
        <th>#</th><th>Fecha</th><th>Matrícula</th><th>Estado</th><th>Acción</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <h3>Completados</h3>
  <table id="tablaCompletados">
    <thead>
      <tr>
        <th>#</th><th>Fecha</th><th>Matrícula</th><th>Estado</th><th>Condición</th><th>PDF</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

<script>
const url = 'https://script.google.com/macros/s/AKfycbw5EncQWBm3x3Zmzhv_BJo0ui_apq1pq1-hx7C9geLm9SQIB5oO3nn4zNrX9GW2aj6B/exec';

let dataPendientes = [];
let dataCompletados = [];

function formatFecha(fechaStr) {
  if(!fechaStr) return '';
  const d = new Date(fechaStr);
  if(isNaN(d)) return '';
  const dd = String(d.getDate()).padStart(2,'0');
  const mm = String(d.getMonth()+1).padStart(2,'0');
  const yyyy = d.getFullYear();
  return `${dd}/${mm}/${yyyy}`;
}

function llenarFiltroMatricula() {
  const selectMat = document.getElementById('filtroMatricula');
  const todasMatriculas = new Set();
  dataPendientes.concat(dataCompletados).forEach(f => {
    if(f.Matrícula) todasMatriculas.add(f.Matrícula);
  });
  
  selectMat.innerHTML = '<option value="">Todas</option>';
  Array.from(todasMatriculas).sort().forEach(mat => {
    const option = document.createElement('option');
    option.value = mat;
    option.textContent = mat;
    selectMat.appendChild(option);
  });
}

function aplicarFiltrosYRender() {
  const filtroFecha = document.getElementById('filtroFecha').value;
  const filtroMatricula = document.getElementById('filtroMatricula').value;

  const filtrar = (f) => {
    let coincide = true;
    if(filtroFecha) {
      const fForm = new Date(f.Fecha);
      const fFiltro = new Date(filtroFecha);
      coincide = coincide && (fForm.toDateString() === fFiltro.toDateString());
    }
    if(filtroMatricula) {
      coincide = coincide && (f.Matrícula === filtroMatricula);
    }
    return coincide;
  };

  renderTabla(dataPendientes.filter(filtrar), 'tablaPendientes', true);
  renderTabla(dataCompletados.filter(filtrar), 'tablaCompletados', false);
}

function renderTabla(datos, tablaId, esPendiente){
  const tbody = document.querySelector(`#${tablaId} tbody`);
  tbody.innerHTML = '';
  datos.forEach((f,i)=>{
    const fila = document.createElement('tr');
    if(esPendiente){
      fila.innerHTML = `<td>${i+1}</td><td>${formatFecha(f.Fecha)}</td><td>${f.Matrícula}</td><td>${f.Estado}</td>
        <td><button onclick="abrirRecepcion('${f.ID}')">Abrir Recepción</button></td>`;
    } else {
      fila.innerHTML = `<td>${i+1}</td><td>${formatFecha(f.Fecha)}</td><td>${f.Matrícula}</td><td>${f.Estado}</td>
        <td>${f.Conforme || ''}</td>
        <td><a href="${f['PDF Generado URL']}" target="_blank">Ver PDF</a></td>`;
    }
    tbody.appendChild(fila);
  });
}

function abrirRecepcion(id){
  window.open('recepcion.html?id=' + encodeURIComponent(id), '_blank');
}

async function cargarDatos(){
  try {
    let resp = await fetch(url + '?action=list');
    let data = await resp.json();
    dataPendientes = data.pendientes;
    dataCompletados = data.completados;

    llenarFiltroMatricula();
    aplicarFiltrosYRender();
  } catch(err){
    alert('Error al cargar listado: ' + err.message);
  }
}

document.getElementById('filtroFecha').addEventListener('change', aplicarFiltrosYRender);
document.getElementById('filtroMatricula').addEventListener('change', aplicarFiltrosYRender);

window.onload = cargarDatos;
</script>
</body>
</html>
