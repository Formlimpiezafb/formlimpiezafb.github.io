<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Listado de Formularios - Control de Limpieza</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: 'Segoe UI', sans-serif;
    background-color: #fff8d6;
    overflow-x: hidden;
    padding: 20px;
    position: relative;
  }

  h2 { color: #333; margin-bottom: 20px; text-align: center; position: relative; z-index: 10; }

  .filters {
    margin-bottom: 20px;
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 15px;
    position: relative;
    z-index: 10;
  }

  .filters label {
    font-weight: bold;
    color: #333;
  }

  select, input[type="date"] {
    padding: 8px;
    border-radius: 8px;
    border: 1px solid #ccc;
    min-width: 150px;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
    background-color: #fffde6;
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 0 15px rgba(0,0,0,0.1);
    position: relative;
    z-index: 10;
  }

  th, td {
    padding: 10px;
    border: 1px solid #f0e8c2;
    text-align: center;
  }

  th {
    background-color: #f6b800;
    color: white;
    font-weight: bold;
  }

  tbody tr:nth-child(even) { background-color: #fff9d1; }

  a.btn-pdf {
    background-color: #f6b800;
    color: white;
    padding: 5px 10px;
    border-radius: 8px;
    text-decoration: none;
    transition: background-color 0.3s;
  }
  a.btn-pdf:hover { background-color: #e0a000; }

  button {
    padding: 5px 10px;
    border-radius: 8px;
    background-color: #f6b800;
    color: white;
    border: none;
    cursor: pointer;
    transition: background-color 0.3s;
  }
  button:hover { background-color: #e0a000; }

  /* NUBES */
  .cloud {
    position: absolute;
    background: url("data:image/svg+xml;utf8,\
<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 120 60'>\
<circle cx='30' cy='30' r='20' fill='white'/><circle cx='50' cy='25' r='25' fill='white'/><circle cx='75' cy='30' r='20' fill='white'/></svg>") no-repeat center;
    background-size: contain;
    width: 200px;
    height: 100px;
    opacity: 0.6;
    z-index: 1; /* detrás del contenido */
  }

  @keyframes cloud-left { 0% { transform: translateX(-300px); } 100% { transform: translateX(100vw); } }
  @keyframes cloud-right { 0% { transform: translateX(100vw); } 100% { transform: translateX(-300px); } }

  /* LOGO ESTÁTICO */
  #logoImg {
    position: fixed;
    top: 20px;
    right: 30px;
    width: 280px;
    height: 140px;
    z-index: 10;
  }
  #logoImg img {
    width: 100%;
    height: 100%;
    object-fit: contain;
  }
</style>
</head>
<body>

<!-- LOGO -->
<div id="logoImg">
  <img src="https://i.imgur.com/evesmtC.png" alt="Logo">
</div>

<h2>Listado de Formularios</h2>

<div class="filters">
  <label>Fecha: <input type="date" id="filtroFecha"></label>
  <label>Matrícula: 
    <select id="filtroMatricula"><option value="">Todas</option></select>
  </label>
</div>

<h3>Pendientes</h3>
<table id="tablaPendientes">
  <thead>
    <tr>
      <th>#</th><th>Fecha</th><th>Matrícula</th><th>Estado</th><th>Acción</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<h3>Completados</h3>
<table id="tablaCompletados">
  <thead>
    <tr>
      <th>#</th><th>Fecha</th><th>Matrícula</th><th>Estado</th><th>Condición</th><th>PDF</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
const url = 'https://script.google.com/macros/s/AKfycbw5EncQWBm3x3Zmzhv_BJo0ui_apq1pq1-hx7C9geLm9SQIB5oO3nn4zNrX9GW2aj6B/exec';
let dataPendientes = [];
let dataCompletados = [];

function formatFecha(fechaStr) {
  if(!fechaStr) return '';
  const d = new Date(fechaStr);
  if(isNaN(d)) return '';
  const dd = String(d.getDate()).padStart(2,'0');
  const mm = String(d.getMonth()+1).padStart(2,'0');
  const yyyy = d.getFullYear();
  return `${dd}/${mm}/${yyyy}`;
}

function llenarFiltroMatricula() {
  const selectMat = document.getElementById('filtroMatricula');
  const todasMatriculas = new Set();
  dataPendientes.concat(dataCompletados).forEach(f => {
    if(f.Matrícula) todasMatriculas.add(f.Matrícula);
  });
  selectMat.innerHTML = '<option value="">Todas</option>';
  Array.from(todasMatriculas).sort().forEach(mat => {
    const option = document.createElement('option');
    option.value = mat;
    option.textContent = mat;
    selectMat.appendChild(option);
  });
}

function aplicarFiltrosYRender() {
  const filtroFecha = document.getElementById('filtroFecha').value;
  const filtroMatricula = document.getElementById('filtroMatricula').value;

  const filtrar = (f) => {
    let coincide = true;
    if(filtroFecha) {
      const fForm = new Date(f.Fecha);
      const fFiltro = new Date(filtroFecha);
      coincide = coincide && (fForm.toDateString() === fFiltro.toDateString());
    }
    if(filtroMatricula) {
      coincide = coincide && (f.Matrícula === filtroMatricula);
    }
    return coincide;
  };

  renderTabla(dataPendientes.filter(filtrar), 'tablaPendientes', true);
  renderTabla(dataCompletados.filter(filtrar), 'tablaCompletados', false);
}

function renderTabla(datos, tablaId, esPendiente){
  const tbody = document.querySelector(`#${tablaId} tbody`);
  tbody.innerHTML = '';
  datos.forEach((f,i)=>{
    const fila = document.createElement('tr');
    if(esPendiente){
      fila.innerHTML = `<td>${i+1}</td><td>${formatFecha(f.Fecha)}</td><td>${f.Matrícula}</td><td>${f.Estado}</td>
        <td><button onclick="abrirRecepcion('${f.ID}')">Abrir Recepción</button></td>`;
    } else {
      let condicion = f["Conforme?"] || '';
      let pdfUrl = f["PDF Generado URL"] || f["U"] || '';
      let pdfLink = '';
      if(pdfUrl){
        const match = pdfUrl.match(/\/d\/([a-zA-Z0-9_-]+)/);
        if(match){
          const fileId = match[1];
          pdfLink = `https://drive.google.com/uc?export=view&id=${fileId}`;
        } else {
          pdfLink = pdfUrl;
        }
      }

      fila.innerHTML = `<td>${i+1}</td>
                        <td>${formatFecha(f.Fecha)}</td>
                        <td>${f.Matrícula}</td>
                        <td>${f.Estado}</td>
                        <td>${condicion}</td>
                        <td>${pdfLink ? `<a href="${pdfLink}" target="_blank" class="btn-pdf">Ver PDF</a>` : ''}</td>`;
    }
    tbody.appendChild(fila);
  });
}

function abrirRecepcion(id){
  window.open('recepcion.html?id=' + encodeURIComponent(id), '_blank');
}

async function cargarDatos(){
  try {
    let resp = await fetch(url + '?action=list');
    let data = await resp.json();
    dataPendientes = data.pendientes;
    dataCompletados = data.completados;
    llenarFiltroMatricula();
    aplicarFiltrosYRender();
  } catch(err){
    alert('Error al cargar listado: ' + err.message);
  }
}

document.getElementById('filtroFecha').addEventListener('change', aplicarFiltrosYRender);
document.getElementById('filtroMatricula').addEventListener('change', aplicarFiltrosYRender);

window.onload = cargarDatos;
</script>

<!-- NUBES -->
<script>
const numClouds = 15;
for (let i=0;i<numClouds;i++){
  const cloud = document.createElement('div');
  cloud.classList.add('cloud');
  const top = Math.random()*80;
  const left = Math.random()*100;
  cloud.style.top = `${top}vh`;
  cloud.style.left = `${left}vw`;
  cloud.style.animation = `cloud-left ${40 + Math.random()*60}s linear infinite`;
  if(Math.random()>0.5) cloud.style.animation = `cloud-right ${40 + Math.random()*60}s linear infinite`;
  cloud.style.transform = `scale(${0.6 + Math.random()*1})`;
  document.body.appendChild(cloud);
}
</script>

</body>
</html>
