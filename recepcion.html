<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>Formulario Recepción</title>
<style>
  body { font-family: Arial, sans-serif; max-width: 600px; margin: auto; }
  label { display: block; margin-top: 15px; }
  input, select, textarea { width: 100%; padding: 8px; margin-top: 5px; }
  canvas { border: 1px solid #ccc; margin-top: 5px; }
  button { margin-top: 20px; padding: 10px 20px; }
  input[readonly], textarea[readonly], select[disabled] {
    background: #eee;
    pointer-events: none;
  }
</style>
</head>
<body>
  <h2>Formulario Recepción</h2>

  <form id="formRecepcion" style="display:none;" enctype="multipart/form-data">
    <fieldset disabled>
      <label>Fecha limpieza:
        <input type="date" name="fecha" id="fecha" readonly />
      </label>
      <label>Matrícula:
        <input type="text" name="matricula" id="matricula" readonly />
      </label>
      <label>Posición:
        <input type="text" name="posicion" id="posicion" readonly />
      </label>
      <label>Hora Inicio:
        <input type="time" name="horaInicio" id="horaInicio" readonly />
      </label>
      <label>Hora Fin:
        <input type="time" name="horaFin" id="horaFin" readonly />
      </label>
      <label>Tipo de Limpieza:
        <input type="text" name="tipoLimpieza" id="tipoLimpieza" readonly />
      </label>
      <label>Responsable limpieza:
        <input type="text" name="responsable" id="responsable" readonly />
      </label>
      <label>Observaciones limpieza:
        <textarea name="observaciones" id="observaciones" rows="3" readonly></textarea>
      </label>
    </fieldset>

    <label>Fecha recepción:
      <input type="date" name="fechaRecepcion" id="fechaRecepcion" required />
    </label>
    <label>Hora recepción:
      <input type="time" name="horaRecepcion" id="horaRecepcion" required />
    </label>
    <label>¿Está conforme la limpieza?
      <select name="conforme" id="conforme" required>
        <option value="">Seleccione</option>
        <option value="Conforme">Conforme</option>
        <option value="No Conforme">No Conforme</option>
      </select>
    </label>
    <label>Observaciones recepción:
      <textarea name="observacionesRecep" id="observacionesRecep" rows="3"></textarea>
    </label>

    <label>Firma (tocar o click y dibujar):</label>
    <canvas id="canvasFirma" width="400" height="150"></canvas>
    <button type="button" id="clearFirma">Limpiar Firma</button>

    <label>Adjuntar archivos:
      <input type="file" name="files" multiple />
    </label>

    <input type="hidden" name="id" id="formIdHidden" />
    <input type="hidden" name="formType" value="recepcion" />

    <button type="submit">Enviar Recepción</button>
  </form>

<script>
const url = 'https://script.google.com/macros/s/AKfycbw5EncQWBm3x3Zmzhv_BJo0ui_apq1pq1-hx7C9geLm9SQIB5oO3nn4zNrX9GW2aj6B/exec';

const canvas = document.getElementById('canvasFirma');
const ctx = canvas.getContext('2d');
let drawing = false;

canvas.addEventListener('mousedown', (e) => {
  drawing = true;
  ctx.beginPath();
  ctx.moveTo(e.offsetX, e.offsetY);
});
canvas.addEventListener('mouseup', (e) => {
  drawing = false;
});
canvas.addEventListener('mouseout', (e) => {
  drawing = false;
});
canvas.addEventListener('mousemove', (e) => {
  if(drawing){
    ctx.lineTo(e.offsetX, e.offsetY);
    ctx.stroke();
  }
});
canvas.addEventListener('touchstart', (e) => {
  e.preventDefault();
  const rect = canvas.getBoundingClientRect();
  const touch = e.touches[0];
  ctx.beginPath();
  ctx.moveTo(touch.clientX - rect.left, touch.clientY - rect.top);
  drawing = true;
});
canvas.addEventListener('touchend', (e) => {
  e.preventDefault();
  drawing = false;
});
canvas.addEventListener('touchmove', (e) => {
  e.preventDefault();
  if(!drawing) return;
  const rect = canvas.getBoundingClientRect();
  const touch = e.touches[0];
  ctx.lineTo(touch.clientX - rect.left, touch.clientY - rect.top);
  ctx.stroke();
});

document.getElementById('clearFirma').onclick = () => {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
}

async function cargarFormularioPorId(id){
  try {
    let resp = await fetch(url + '?action=list');
    let data = await resp.json();

    let pendientes = data.pendientes.concat(data.completados);
    let formData = pendientes.find(f => f.ID === id);

    if(!formData){
      alert('No se encontró formulario con ese ID');
      return;
    }

    // Mostrar formulario y completar datos en modo solo lectura
    document.getElementById('formRecepcion').style.display = 'block';
    document.getElementById('formIdHidden').value = id;

    // Campos limpieza
    document.getElementById('fecha').value = formData.Fecha || '';
    document.getElementById('matricula').value = formData.Matrícula || '';
    document.getElementById('posicion').value = formData.Posición || '';
    document.getElementById('horaInicio').value = formData['Hora Inicio'] || '';
    document.getElementById('horaFin').value = formData['Hora Fin'] || '';
    document.getElementById('tipoLimpieza').value = formData['Tipo Limpieza'] || '';
    document.getElementById('responsable').value = formData.Responsable || '';
    document.getElementById('observaciones').value = formData.Observaciones || '';

  } catch(err){
    alert('Error al cargar datos: ' + err.message);
  }
}

window.onload = () => {
  const params = new URLSearchParams(window.location.search);
  if(params.has('id')){
    cargarFormularioPorId(params.get('id'));
  } else {
    alert('No se recibió ID para cargar formulario');
  }
};

document.getElementById('formRecepcion').onsubmit = async (e) => {
  e.preventDefault();

  const blank = document.createElement('canvas');
  blank.width = canvas.width;
  blank.height = canvas.height;
  if(canvas.toDataURL() === blank.toDataURL()){
    alert('Por favor, firme antes de enviar');
    return;
  }

  const formData = new FormData(e.target);
  formData.append('firma', canvas.toDataURL());

  try {
    const resp = await fetch(url, {method:'POST', body: formData});
    const data = await resp.json();
    if(data.status === 'ok'){
      alert('Recepción enviada correctamente. PDF: ' + data.pdfUrl);
      e.target.reset();
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      document.getElementById('formRecepcion').style.display = 'none';
    } else {
      alert('Error: ' + data.message);
    }
  } catch(err){
    alert('Error al enviar: ' + err.message);
  }
};
</script>
</body>
</html>
