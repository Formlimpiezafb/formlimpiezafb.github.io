<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Formulario Recepción</title>
<style>
  body { font-family: Arial, sans-serif; max-width: 600px; margin: auto; background-color: #fff8d6; padding: 20px; }
  label { display: block; margin-top: 15px; }
  input, select, textarea { width: 100%; padding: 8px; margin-top: 5px; }
  canvas { border: 1px solid #ccc; margin-top: 5px; }
  button { margin-top: 20px; padding: 10px 20px; border-radius: 8px; background-color:#f6b800; color:white; border:none; cursor:pointer; }
  button:hover { background-color: #e0a000; }
  input[readonly], textarea[readonly], select[disabled] { background: #eee; pointer-events: none; }

  #pdfModal { display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.8); align-items:center; justify-content:center; z-index:1000; }
  #pdfModal iframe { width:90%; height:90%; border:none; }
</style>
</head>
<body>
<h2>Formulario Recepción</h2>

<form id="formRecepcion" style="display:none;" enctype="multipart/form-data">
  <fieldset disabled>
    <label>Fecha limpieza:<input type="date" id="fecha" name="fecha" readonly /></label>
    <label>Matrícula:<input type="text" id="matricula" name="matricula" readonly /></label>
    <label>Posición:<input type="text" id="posicion" name="posicion" readonly /></label>
    <label>Hora Inicio:<input type="time" id="horaInicio" name="horaInicio" readonly /></label>
    <label>Hora Fin:<input type="time" id="horaFin" name="horaFin" readonly /></label>
    <label>Tipo de Limpieza:<input type="text" id="tipoLimpieza" name="tipoLimpieza" readonly /></label>
    <label>Responsable limpieza:<input type="text" id="responsable" name="responsable" readonly /></label>
    <label>Observaciones limpieza:<textarea id="observaciones" name="observaciones" rows="3" readonly></textarea></label>
  </fieldset>

  <label>Fecha recepción:<input type="date" name="fechaRecepcion" id="fechaRecepcion" required /></label>
  <label>Hora recepción:<input type="time" name="horaRecepcion" id="horaRecepcion" required /></label>
  <label>¿Está conforme la limpieza?
    <select name="conforme" id="conforme" required>
      <option value="">Seleccione</option>
      <option value="Conforme">Conforme</option>
      <option value="No Conforme">No Conforme</option>
    </select>
  </label>
  <label>Observaciones recepción:<textarea name="observacionesRecep" id="observacionesRecep" rows="3"></textarea></label>

  <label>Firma (tocar o click y dibujar):</label>
  <canvas id="canvasFirma" width="400" height="150"></canvas>
  <button type="button" id="clearFirma">Limpiar Firma</button>

  <label>Adjuntar archivos:<input type="file" name="files" multiple /></label>

  <input type="hidden" name="id" id="formIdHidden" />
  <input type="hidden" name="formType" value="recepcion" />

  <button type="submit">Enviar Recepción</button>
</form>

<div id="pdfModal" onclick="cerrarModal()">
  <iframe id="pdfFrame"></iframe>
</div>

<script>
const url = 'https://script.google.com/macros/s/AKfycbw5EncQWBm3x3Zmzhv_BJo0ui_apq1pq1-hx7C9geLm9SQIB5oO3nn4zNrX9GW2aj6B/exec';

const canvas = document.getElementById('canvasFirma');
const ctx = canvas.getContext('2d');
let drawing = false;

// Funciones para formatear fecha y hora
function formatFechaInput(f){
  if(!f) return '';
  if(f.includes('/')){ // caso: 18/08/2025
    let [d,m,y] = f.split('/');
    return `${y}-${m.padStart(2,'0')}-${d.padStart(2,'0')}`;
  }
  if(f.includes('-')) return f; // caso ya correcto
  return '';
}
function formatHoraInput(h){
  if(!h) return '';
  return h.split(':').slice(0,2).join(':'); // 14:30:00 -> 14:30
}

// --- Firma ---
canvas.addEventListener('mousedown', e => { drawing = true; ctx.beginPath(); ctx.moveTo(e.offsetX, e.offsetY); });
canvas.addEventListener('mouseup', () => { drawing = false; });
canvas.addEventListener('mousemove', e => { if(drawing){ ctx.lineTo(e.offsetX, e.offsetY); ctx.stroke(); }});
canvas.addEventListener('touchstart', e => { e.preventDefault(); const rect = canvas.getBoundingClientRect(); const touch = e.touches[0]; ctx.beginPath(); ctx.moveTo(touch.clientX - rect.left, touch.clientY - rect.top); drawing = true; });
canvas.addEventListener('touchend', () => { drawing = false; });
canvas.addEventListener('touchmove', e => { e.preventDefault(); if(!drawing) return; const rect = canvas.getBoundingClientRect(); const touch = e.touches[0]; ctx.lineTo(touch.clientX - rect.left, touch.clientY - rect.top); ctx.stroke(); });
document.getElementById('clearFirma').onclick = () => ctx.clearRect(0,0,canvas.width,canvas.height);

// --- Cargar datos del formulario ---
async function cargarFormularioPorId(id){
  try{
    let resp = await fetch(url + '?action=list');
    let data = await resp.json();
    let pendientes = data.pendientes.concat(data.completados);
    let f = pendientes.find(r => r.ID === id);
    if(!f){ alert('No se encontró el formulario con ese ID'); return; }

    document.getElementById('formRecepcion').style.display = 'block';
    document.getElementById('formIdHidden').value = id;

    document.getElementById('fecha').value = formatFechaInput(f["Fecha"]);
    document.getElementById('horaInicio').value = formatHoraInput(f["Hora Inicio"]);
    document.getElementById('horaFin').value = formatHoraInput(f["Hora Fin"]);
    document.getElementById('matricula').value = f["Matrícula"];
    document.getElementById('posicion').value = f["Posición"];
    document.getElementById('tipoLimpieza').value = f["Tipo Limpieza"];
    document.getElementById('responsable').value = f["Responsable"];
    document.getElementById('observaciones').value = f["Observaciones"];
  }catch(err){ alert('Error cargando datos: ' + err.message); }
}

window.onload = () => {
  const params = new URLSearchParams(window.location.search);
  if(params.has('id')) cargarFormularioPorId(params.get('id'));
  else alert('No se recibió ID');
};

// --- Modal PDF ---
function mostrarPDF(url){
  const iframe = document.getElementById('pdfFrame');
  const match = url.match(/\/d\/([a-zA-Z0-9_-]+)/);
  iframe.src = match ? `https://drive.google.com/file/d/${match[1]}/preview` : url;
  document.getElementById('pdfModal').style.display = 'flex';
}
function cerrarModal(){
  document.getElementById('pdfModal').style.display = 'none';
  document.getElementById('pdfFrame').src = '';
}

// --- Enviar recepción ---
document.getElementById('formRecepcion').onsubmit = async (e) => {
  e.preventDefault();
  const blank = document.createElement('canvas'); blank.width = canvas.width; blank.height = canvas.height;
  if(canvas.toDataURL() === blank.toDataURL()){ alert('Firme antes de enviar'); return; }

  const formData = new FormData(e.target);
  formData.append('firma', canvas.toDataURL());

  try{
    let resp = await fetch(url, {method:'POST', body: formData});
    let data = await resp.json();
    if(data.status === 'ok'){
      mostrarPDF(data.pdfUrl);
      e.target.reset();
      ctx.clearRect(0,0,canvas.width,canvas.height);
      document.getElementById('formRecepcion').style.display = 'none';
    }else alert('Error: ' + data.message);
  }catch(err){ alert('Error al enviar: ' + err.message); }
};
</script>
</body>
</html>
