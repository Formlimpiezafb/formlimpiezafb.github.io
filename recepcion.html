<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Recepción de Aeronave</title>
<style>
  body { font-family: Arial, sans-serif; background:#fff8d6; padding:20px; }
  form { background:#fff; padding:20px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.1); max-width:600px; margin:auto; }
  label { display:block; margin-top:12px; font-weight:bold; }
  input, select, textarea { width:100%; padding:8px; margin-top:4px; border-radius:8px; border:1px solid #ccc; }
  textarea { resize:vertical; }
  canvas { width:100%; height:auto; border:2px solid #ccc; margin-top:5px; border-radius:8px; background:white; }
  button { margin-top:15px; padding:10px 20px; background:#f6b800; color:white; border:none; border-radius:8px; cursor:pointer; font-weight:bold; }
</style>
</head>
<body>

<h2>Recepción de Aeronave</h2>

<form id="formRecepcion" enctype="multipart/form-data">
  <input type="hidden" name="formType" value="recepcion">
  <input type="hidden" name="id" id="id">

  <fieldset>
    <legend>Datos de Limpieza (solo lectura)</legend>
    <label>Fecha Limpieza: <input type="text" id="fechaLimp" readonly></label>
    <label>Matrícula: <input type="text" id="matriculaLimp" readonly></label>
    <label>Posición: <input type="text" id="posicionLimp" readonly></label>
    <label>Hora Inicio: <input type="text" id="horaInicioLimp" readonly></label>
    <label>Hora Fin: <input type="text" id="horaFinLimp" readonly></label>
    <label>Tipo Limpieza: <input type="text" id="tipoLimp" readonly></label>
    <label>Responsable Limpieza: <input type="text" id="respLimp" readonly></label>
    <label>Observaciones Limpieza: <textarea id="obsLimp" readonly></textarea></label>
  </fieldset>

  <fieldset>
    <legend>Datos de Recepción</legend>
    <label>Fecha Recepción: <input type="date" name="fechaRecepcion" required></label>
    <label>Hora Recepción: <input type="time" name="horaRecepcion" required></label>
    <label>Conforme?: 
      <select name="conforme" required>
        <option value="">Seleccione</option>
        <option value="SI">Sí</option>
        <option value="NO">No</option>
      </select>
    </label>
    <label>Observaciones Recepción: <textarea name="observacionesRecep" rows="3"></textarea></label>
    <label>Firma Receptor:</label>
    <canvas id="canvasFirma"></canvas>
    <button type="button" id="clearFirma">Limpiar Firma</button>
    <label>Adjuntar Archivos: <input type="file" name="files" multiple></label>
  </fieldset>

  <button type="submit">Enviar Recepción</button>
</form>

<script>
const urlScript = "https://script.google.com/macros/s/AKfycbw5EncQWBm3x3Zmzhv_BJo0ui_apq1pq1-hx7C9geLm9SQIB5oO3nn4zNrX9GW2aj6B/exec";

// 🎯 Obtener ID de la URL
const params = new URLSearchParams(window.location.search);
const formId = params.get("id");
document.getElementById("id").value = formId;

// 🎯 Traer datos de limpieza
async function cargarDatos() {
  try {
    const resp = await fetch(`${urlScript}?action=get&id=${formId}`);
    const data = await resp.json();
    if (data.status === "ok") {
      const f = data.form;
      // Asumo que coincide con el orden de columnas que me diste
      document.getElementById("fechaLimp").value = f[1];
      document.getElementById("matriculaLimp").value = f[2];
      document.getElementById("posicionLimp").value = f[3];
      document.getElementById("horaInicioLimp").value = f[4];
      document.getElementById("horaFinLimp").value = f[5];
      document.getElementById("tipoLimp").value = f[6];
      document.getElementById("respLimp").value = f[7];
      document.getElementById("obsLimp").value = f[9];
    } else {
      alert("Error: " + data.message);
    }
  } catch (err) {
    alert("Error cargando datos: " + err.message);
  }
}
cargarDatos();

// 🎨 Firma receptor
const canvas = document.getElementById('canvasFirma');
const ctx = canvas.getContext('2d');
let drawing = false;
canvas.width = 400; canvas.height = 150;
canvas.addEventListener('mousedown', e => {drawing = true; ctx.beginPath(); ctx.moveTo(e.offsetX,e.offsetY);});
canvas.addEventListener('mouseup', ()=>drawing=false);
canvas.addEventListener('mousemove', e => {if(drawing){ctx.lineTo(e.offsetX,e.offsetY); ctx.stroke();}});
canvas.addEventListener('touchstart', e=>{e.preventDefault(); drawing=true; ctx.beginPath(); ctx.moveTo(e.touches[0].clientX-canvas.offsetLeft, e.touches[0].clientY-canvas.offsetTop);});
canvas.addEventListener('touchend', e=>{drawing=false;});
canvas.addEventListener('touchmove', e=>{e.preventDefault(); if(!drawing) return; ctx.lineTo(e.touches[0].clientX-canvas.offsetLeft, e.touches[0].clientY-canvas.offsetTop); ctx.stroke();});
document.getElementById("clearFirma").onclick = ()=>ctx.clearRect(0,0,canvas.width,canvas.height);

// 📤 Envío del formulario
document.getElementById("formRecepcion").onsubmit = async e => {
  e.preventDefault();
  const blank = document.createElement("canvas"); blank.width=canvas.width; blank.height=canvas.height;
  if (canvas.toDataURL() === blank.toDataURL()) {
    alert("Por favor, firme antes de enviar");
    return;
  }

  const formData = new FormData(e.target);
  formData.append("firmaRecep", canvas.toDataURL());

  try {
    const resp = await fetch(urlScript, { method:"POST", body:formData });
    const data = await resp.json();
    if (data.status === "ok") {
      alert("Recepción guardada con ID: " + data.id);
      location.reload();
    } else {
      alert("Error: " + data.message);
    }
  } catch (err) {
    alert("Error al enviar: " + err.message);
  }
};
</script>
</body>
</html>
